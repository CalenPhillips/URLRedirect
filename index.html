<!DOCTYPE html>
<html>
<head>
  <title>Redirecting...</title>
  <script>
    async function redirect() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (!id) return;

      // Log analytics to Power Automate
      try {
        await fetch("https://337123657c26e70a8c4a3f818a15b9.ca.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/84cfcf510b404df496ddaae75f7a4b43/triggers/manual/paths/invoke/?api-version=1&tenantId=tId&environmentName=33712365-7c26-e70a-8c4a-3f818a15b9ca&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=X4w9Kn-rxdCdLCU7HOkWC35HmJZV5-tZhAGLG1XaVA0", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: id,
            userAgent: navigator.userAgent,
            referrer: document.referrer,
            timestamp: new Date().toISOString()
          })
        });
      } catch (e) {
        console.warn("Logging failed:", e);
      }

      // Fetch redirect URL from Logic App
      try {
        const response = await fetch(`https://prod-22.australiasoutheast.logic.azure.com:443/workflows/132220a298e44e50be4dad0eefbfd043/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EpJncW5yT91DFUDJy_PL2SGW59XzhAB26rG03baiu3I&id=${id}`);
        const data = await response.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          document.body.innerText = "Redirect failed.";
        }
      } catch (e) {
        document.body.innerText = "Error during redirect.";
        console.error(e);
      }
    }

    redirect();
  </script>
</head>
<body>
  Redirecting...
</body>
</html>
